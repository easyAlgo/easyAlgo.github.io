/**
 * runner for easyAlgo expression parsed with the easyAlgoParser.js
 */define(["easyAlgoConfiguration","easyAlgoContext","easyAlgoRuntimeException","easyAlgoLanguage/mods/base/runner","easyAlgoLanguage/easyAlgoStopBlockException"],function(e,t,n,r,i){var s="prototype",o="context",u="lines",a="lineProcessor",f="currentLine",l="onEndFunction",c="fatalError",h=!1,p="proccessingChild",d="push",v="length",m="runNextLine",g="haveFatalError",y=!0,b="blockEnd",w="endOfLineHandler",E="haveARunningChild",S="registerEndFunction",x="isArray",T=" doit être du type ",N="array",C="string",k="number",L="boolean",A="type",O="offset",M="isset",_="name",D="indexs",P="function",H="params",B="parameters",j="varname",F="setValue",I="runChildBlock",q="expression",R="commandName",U="defineFunction",z="blockRunner",W=function(e,t){this.output=e,this.input=t,this.mods={};var n=r(t,e);for(var i in n)this.mods[i]=n[i]};return W[s].run=function(r,W){var X=this.input,V=this.output,$=e.getFunctions(),J=e.getSkipedFunction(),K=0,Q=this,G=0,Y=function(e,t,n,r){this[o]=e,this[u]=t,this.parent=n,this[a]=r,this[f]=0,this[l]=[],this[c]=h,this[p]=undefined,this.id=G++};Y[s]={registerEndFunction:function(e){this[l][d](e)},blockEnd:function(e){for(var t=this[l][v]-1;t>=0;t--){var n=this[l][t](e);if(n===h)break}},runLine:function(e,t){K++;var n=this;try{this[a].runLine(e,this[o],this,function(){t&&t(),n[m]()})}catch(r){r instanceof i?t(r):(this[g](r),V.error(r),console.log(r))}},haveFatalError:function(e){this[c]=y,this.getParent()?this.getParent()[g](e):this[b](e)},runNextLine:function(){if(this[c]||this.stoped===y)return;this[u][v]==0&&this[w]();if(this[f]<this[u][v]){var e=this,t=this[f]+1;this.runLine(this[u][this[f]++],function(t){e[w](t)})}},haveARunningChild:function(){return this[p]!=undefined},endOfLineHandler:function(e){if(e){this[b](e);return}if(this[f]>=this[u][v])if(!this[E]())this[b]();else{var t=this;this[p][S](function(){t[b]()})}},runChildBlock:function(e,n,r){var s=r!=undefined,l=r||new t(this[o]),c=new Y(l,e,this,this[a]);this[p]=c;var h=this,d=function(e){if(e&&!s){h[b](e);return}h[p]=undefined;try{n(e?e.returnedValue:undefined)}catch(t){if(t instanceof i){h[b](t);return}throw t}s||h[E]()!==y&&h[f]<h[u][v]&&h[m]()};c[S](d);var w=function(){try{c[m]()}catch(e){e instanceof i&&d(e),h[g](),V.error(e),console.log(e)}};K>=500?(K=0,setTimeout(w,0)):w()},getParent:function(){return this.parent},stop:function(){this[p]&&this[p].stop(),this.stoped=y}};var Z=undefined,et={number:"Nombre","boolean":"Booleen",string:"Chaine",array:"Tableau"},tt=function(e,t,r){if(Array[x](t)){var i=[];for(var s in t){i[d](et[t[s]]);try{if(tt(e,t[s],r))return y}catch(o){}}throw new n(e+T+i.join(" ou "),r)}if(typeof e==t||t==N&&Array[x](e))return y;throw new n(e+T+(et[t]||t),r)},nt=function(e,t,n,r){switch(n){case"+":if(typeof e==C||typeof t==C)e=st(e),t=st(t);return e+t;case"-":return tt(e,k,r),tt(t,k,r),e-t;case"*":return tt(e,k,r),tt(t,k,r),e*t;case"/":return tt(e,k,r),tt(t,k,r),e/t;case"mod":case"%":return tt(e,k,r),tt(t,k,r),e%t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t;case"==":return e==t;case"<>":case"!=":return e!=t;case"&&":return tt(e,L,r),tt(t,L,r),e&&t;case"||":return tt(e,L,r),tt(t,L,r),e||t;default:return undefined}},rt=function(e,t,n){if(e==undefined||e[v]==0){n();return}var r=e[v],i=-1,s=function(){++i;if(i<r){var o=e[i];t(s,o,i)}else n&&n()};s()},it=function(e,r,i,s){if(e==undefined){s();return}if(typeof e==C||typeof e==k||typeof e==L){s(e);return}if(e.operation||e[A]=="comparaison"||e[A]==L){it(e.left,r,i,function(t){it(e.right,r,i,function(n){var r=nt(t,n,e.operation,e[O]);s(r)})});return}if(e[A]=="var"){r[M](e[_],y,e[O]);var u=r.getValue(e[_]);if(e[D]!=undefined&&e[D][v]>0){var a=[];rt(e[D],function(t,s){if(s=="ADD_AT_END")throw new n("Vous devez préciser l'indice de l'element à accéder.",e[O]);it(s,r,i,function(n){a[d](n),tt(u,[N,C],e[O]),u=u[n],t()})},function(){s(u)});return}s(u);return}if(e[A]==P){r.issetFunction(e[_],y,e[O]);var f=r.getFunction(e[_]);if(typeof f==P){var l=[];rt(e[H],function(e,t){it(t,r,i,function(t){l[d](t),e()})},function(){var e=f.apply(undefined,l);s(e)});return}if(typeof f=="object"){var c=new t(i[o],e[_]);if(f[B][v]!=e[H][v])throw new n("Le nombre de paramétre n'est pas correcte, la fonction "+espression[_]+" prend "+e[H][v]+" paramètre(s)",e[O]);rt(f[B],function(t,n,s){c.defineVar(n[j],n.vartype),it(e[H][s],r,i,function(e){c[F](n[j],e),t()})},function(){i[I](f.body,function(e){s(e)},c)});return}throw new n("La fonction "+e[_]+" n'existe pas",e[O])}if(e[A]==N){var h=[];rt(e.elements,function(e,t){it(t[q],r,i,function(n){t[_]!=undefined?h[t[_]]=n:h[d](n),e()})},function(){s(h)})}},st=function(t){if(t==undefined)return"NON_INITIALISEE";if(t===y||t===h)return e.translatedBooleanName[t].toLowerCase();if(Array[x](t)){var n="[";for(var r in t)n+=" ",isNaN(r)&&(n+=r+" : "),n+=st(t[r])+",";return n.substring(0,n[v]-1)+" ]"}return t},ot=function(e,t){return{toString:st,expression:function(n,r){it(n,e,t,r)},context:e,blockRunner:t}},ut=function(e,t,n,r){return e[R]in Q.mods?Q.mods[e[R]](e,ot(t,n),r):e[R]=="affectation"?(t[M](e[j][_],y,e[O]),it(e[q],t,n,function(i){e[j][D]==undefined&&tt(i,t.getType(e[j][_]),e[q][O]||e[O]);var s=[];rt(e[j][D],function(e,r){it(r,t,n,function(t){s[d](t),e()})},function(){t[F](e[j][_],i,s[v]==0?undefined:s),r&&r()})}),h):y},at={runLine:function(e,t,n,r){var i=y;if(e[A]&&e[A]=="command")i=ut(e,t,n,r);else if(e[A]&&e[A]=="condition")it(e.test,t,n,function(t){tt(t,L,e[O]),t&&e.yes&&e.yes[v]>0?n[I](e.yes,r):e.no&&e.no[v]>0?n[I](e.no,r):r&&r()}),i=h;else if(e[A]&&e[A]=="for")t[M](e[j],y,e[O]),it(e.step,t,n,function(i){var s=i===undefined?1:i;it(e.start,t,n,function(i){var o=i-s;it(e.end,t,n,function(i){t[F](e[j],o);var u=function(){o+=s,o<=i?(t[F](e[j],o),n[I](e.block,u)):r&&r()};u()})})}),i=h;else if(e[A]&&e[A]=="forEach"){var s=e[j],o=(s+"_index").toUpperCase();t[M](s,y,e[O]),t.defineVar(o,"NOMBRE"),it(e[N],t,n,function(i){var u=[];for(var a in i)u[d](a);var f=u[v],a=-1,l=function(){a++;if(a<f){var c=u[a],h=i[c];t[F](o,c),t[F](s,h),n[I](e.block,l)}else r&&r()};l()}),i=h}else if(e[A]&&e[A]=="while"){var u=e.test,a=e.block,f=function(){it(u,t,n,function(e){e===y?n[I](a,f):r&&r()})};f(),i=h}else e[A]&&e[A]==P?(it(e,t,n,function(){r&&r()}),i=h):e[A]&&e[A]==U&&t[U](e[_],e[B],e.body);i&&r&&r()}},ft=new t,lt=new Y(ft,r,undefined,at);lt[S](W),setTimeout(function(){lt[m]()},0),this[z]=lt},W[s].stop=function(){this[z]&&this[z].stop()},W});