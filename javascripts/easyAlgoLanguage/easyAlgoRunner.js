/**
 * runner for easyAlgo expression parsed with the easyAlgoParser.js
 */define(["easyAlgoConfiguration","easyAlgoContext","easyAlgoRuntimeException","easyAlgoLanguage/mods/base/runner","easyAlgoLanguage/easyAlgoStopBlockException"],function(e,t,n,r,i){var s="prototype",o="context",u="lines",a="lineProcessor",f="currentLine",l="onEndFunction",c="fatalError",h=!1,p="proccessingChild",d="push",v="length",m="runNextLine",g="haveFatalError",y=!0,b="blockEnd",w="endOfLineHandler",E="haveARunningChild",S="registerEndFunction",x="isArray",T=" doit être du type ",N="array",C="string",k="number",L="boolean",A="type",O="offset",M="isset",_="name",D="indexs",P="La variable ",H="function",B="params",j="parameters",F="varname",I="setValue",q="runChildBlock",R="expression",U="commandName",z="defineFunction",W="blockRunner",X=function(e,t){this.output=e,this.input=t,this.mods={};var n=r(t,e);for(var i in n)this.mods[i]=n[i]};return X[s].run=function(r,X){var V=this.input,$=this.output,J=e.getFunctions(),K=e.getSkipedFunction(),Q=0,G=this,Y=0,Z=function(e,t,n,r){this[o]=e,this[u]=t,this.parent=n,this[a]=r,this[f]=0,this[l]=[],this[c]=h,this[p]=undefined,this.id=Y++};Z[s]={registerEndFunction:function(e){this[l][d](e)},blockEnd:function(e){for(var t=this[l][v]-1;t>=0;t--){var n=this[l][t](e);if(n===h)break}},runLine:function(e,t){Q++;var n=this;try{this[a].runLine(e,this[o],this,function(){t&&t(),n[m]()})}catch(r){r instanceof i?t(r):(this[g](r),$.error(r),console.log(r))}},haveFatalError:function(e){this[c]=y,this.getParent()?this.getParent()[g](e):this[b](e)},runNextLine:function(){if(this[c]||this.stoped===y)return;this[u][v]==0&&this[w]();if(this[f]<this[u][v]){var e=this,t=this[f]+1;this.runLine(this[u][this[f]++],function(t){e[w](t)})}},haveARunningChild:function(){return this[p]!=undefined},endOfLineHandler:function(e){if(e){this[b](e);return}if(this[f]>=this[u][v])if(!this[E]())this[b]();else{var t=this;this[p][S](function(){t[b]()})}},runChildBlock:function(e,n,r){var s=r!=undefined,l=r||new t(this[o]),c=new Z(l,e,this,this[a]);this[p]=c;var h=this,d=function(e){if(e&&!s){h[b](e);return}h[p]=undefined;try{n(e?e.returnedValue:undefined)}catch(t){if(t instanceof i){h[b](t);return}throw t}s||h[E]()!==y&&h[f]<h[u][v]&&h[m]()};c[S](d);var w=function(){try{c[m]()}catch(e){e instanceof i&&d(e),h[g](),$.error(e),console.log(e)}};Q>=500?(Q=0,setTimeout(w,0)):w()},getParent:function(){return this.parent},stop:function(){this[p]&&this[p].stop(),this.stoped=y}};var et=undefined,tt={number:"Nombre","boolean":"Booleen",string:"Chaine",array:"Tableau"},nt=function(e,t,r){if(Array[x](t)){var i=[];for(var s in t){i[d](tt[t[s]]);try{if(nt(e,t[s],r))return y}catch(o){}}throw new n(e+T+i.join(" ou "),r)}if(typeof e==t||t==N&&Array[x](e))return y;throw new n(e+T+(tt[t]||t),r)},rt=function(e,t,n,r){switch(n){case"+":if(typeof e==C||typeof t==C)e=ot(e),t=ot(t);return e+t;case"-":return nt(e,k,r),nt(t,k,r),e-t;case"*":return nt(e,k,r),nt(t,k,r),e*t;case"/":return nt(e,k,r),nt(t,k,r),e/t;case"mod":case"%":return nt(e,k,r),nt(t,k,r),e%t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t;case"==":return e==t;case"<>":case"!=":return e!=t;case"&&":return nt(e,L,r),nt(t,L,r),e&&t;case"||":return nt(e,L,r),nt(t,L,r),e||t;default:return undefined}},it=function(e,t,n){if(e==undefined||e[v]==0){n();return}var r=e[v],i=-1,s=function(){++i;if(i<r){var o=e[i];t(s,o,i)}else n&&n()};s()},st=function(e,r,i,s){if(e==undefined){s();return}if(typeof e==C||typeof e==k||typeof e==L){s(e);return}if(e.operation||e[A]=="comparaison"||e[A]==L){st(e.left,r,i,function(t){st(e.right,r,i,function(n){var r=rt(t,n,e.operation,e[O]);s(r)})});return}if(e[A]=="var"){r[M](e[_],y,e[O]);var u=r.getValue(e[_]);if(e[D]!=undefined&&e[D][v]>0){var a=[];it(e[D],function(t,s){if(s=="ADD_AT_END")throw new n("Vous devez préciser l'indice de l'element à accéder.",e[O]);st(s,r,i,function(n){a[d](n),nt(u,[N,C],e[O]),u=u[n],u==undefined&&$.info(P+e[_]+"["+a.join("][")+"] n'est pas initialisée"),t()})},function(){s(u)});return}u==undefined&&$.info(P+e[_]+" n'est pas initialisée"),s(u);return}if(e[A]==H){r.issetFunction(e[_],y,e[O]);var f=r.getFunction(e[_]);if(typeof f==H){var l=[];it(e[B],function(e,t){st(t,r,i,function(t){l[d](t),e()})},function(){var e=f.apply(undefined,l);s(e)});return}if(typeof f=="object"){var c=new t(i[o],e[_]);if(f[j][v]!=e[B][v])throw new n("Le nombre de paramétre n'est pas correcte, la fonction "+espression[_]+" prend "+e[B][v]+" paramètre(s)",e[O]);it(f[j],function(t,n,s){c.defineVar(n[F],n.vartype),st(e[B][s],r,i,function(e){c[I](n[F],e),t()})},function(){i[q](f.body,function(e){s(e)},c)});return}throw new n("La fonction "+e[_]+" n'existe pas",e[O])}if(e[A]==N){var h=[];it(e.elements,function(e,t){st(t[R],r,i,function(n){t[_]!=undefined?h[t[_]]=n:h[d](n),e()})},function(){s(h)})}},ot=function(t){if(t==undefined)return"NON_INITIALISEE";if(t===y||t===h)return e.translatedBooleanName[t].toLowerCase();if(Array[x](t)){var n="[";for(var r in t)n+=" ",isNaN(r)&&(n+=r+" : "),n+=ot(t[r])+",";return n.substring(0,n[v]-1)+" ]"}return t},ut=function(e,t){return{toString:ot,expression:function(n,r){st(n,e,t,r)},context:e,blockRunner:t}},at=function(e,t,n,r){return e[U]in G.mods?G.mods[e[U]](e,ut(t,n),r):e[U]=="affectation"?(t[M](e[F][_],y,e[O]),st(e[R],t,n,function(i){e[F][D]==undefined&&nt(i,t.getType(e[F][_]),e[R][O]||e[O]);var s=[];it(e[F][D],function(e,r){st(r,t,n,function(t){s[d](t),e()})},function(){t[I](e[F][_],i,s[v]==0?undefined:s),r&&r()})}),h):y},ft={runLine:function(e,t,n,r){var i=y;if(e[A]&&e[A]=="command")i=at(e,t,n,r);else if(e[A]&&e[A]=="condition")st(e.test,t,n,function(t){nt(t,L,e[O]),t&&e.yes&&e.yes[v]>0?n[q](e.yes,r):e.no&&e.no[v]>0?n[q](e.no,r):r&&r()}),i=h;else if(e[A]&&e[A]=="for")t[M](e[F],y,e[O]),st(e.step,t,n,function(i){var s=i===undefined?1:i;st(e.start,t,n,function(i){var o=i-s;st(e.end,t,n,function(i){t[I](e[F],o);var u=function(){o+=s,o<=i?(t[I](e[F],o),n[q](e.block,u)):r&&r()};u()})})}),i=h;else if(e[A]&&e[A]=="forEach"){var s=e[F],o=(s+"_index").toUpperCase();t[M](s,y,e[O]),t.defineVar(o,"NOMBRE"),st(e[N],t,n,function(i){var u=[];for(var a in i)u[d](a);var f=u[v],a=-1,l=function(){a++;if(a<f){var c=u[a],h=i[c];t[I](o,c),t[I](s,h),n[q](e.block,l)}else r&&r()};l()}),i=h}else if(e[A]&&e[A]=="while"){var u=e.test,a=e.block,f=function(){st(u,t,n,function(e){e===y?n[q](a,f):r&&r()})};f(),i=h}else e[A]&&e[A]==H?(st(e,t,n,function(){r&&r()}),i=h):e[A]&&e[A]==z&&t[z](e[_],e[j],e.body);i&&r&&r()}},lt=new t,ct=new Z(lt,r,undefined,ft);ct[S](X),setTimeout(function(){ct[m]()},0),this[W]=ct},X[s].stop=function(){this[W]&&this[W].stop()},X});