/**
 * runner for easyAlgo expression parsed with the easyAlgoParser.js
 */define(["easyAlgoConfiguration","easyAlgoContext","easyAlgoRuntimeException"],function(e,t,n){var r="returnedValue",i="context",s="lines",o="lineProcessor",u="currentLine",a="onEndFunction",f="fatalError",l=!1,c="proccessingChild",h="push",p="length",d="runNextLine",v="haveFatalError",m="error",g=!0,y="endOfLineHandler",b="blockEnd",w="haveARunningChild",E="registerEndFunction",S="isArray",x=" doit être du type ",T="array",N="string",C="number",k="boolean",L="type",A="offset",O="isset",M="name",_="indexs",D="info",P="La variable ",H="function",B="params",j="parameters",F="defineVar",I="varname",q="setValue",R="runChildBlock",U="expression",z="commandName",W="output",X="L'entrée doit être de type ",V="vrai",$="defineFunction",J=function(e){this[r]=e},K={};return K.run=function(K,Q,G,Y){console.log(K);var Z=e.getFunctions(),et=e.getSkipedFunction(),tt=0,nt=function(e,t,n,r){this[i]=e,this[s]=t,this.parent=n,this[o]=r,this[u]=0,this[a]=[],this[f]=l,this[c]=undefined,this.id=tt++};nt.prototype={registerEndFunction:function(e){this[a][h](e)},blockEnd:function(e){for(var t=this[a][p]-1;t>=0;t--){var n=this[a][t](e);if(n===l)break}},runLine:function(e,t){var n=this;try{this[o].runLine(e,this[i],this,function(){t&&t(),n[d]()})}catch(r){r instanceof J?t(r):(this[v](),Q[m](r),console.log(r))}},haveFatalError:function(){this[f]=g,this.getParent()&&this.getParent()[v]()},runNextLine:function(){if(this[f])return;this[s][p]==0&&this[y]();if(this[u]<this[s][p]){var e=this,t=this[u]+1;this.runLine(this[s][this[u]++],function(t){e[y](t)})}},haveARunningChild:function(){return this[c]!=undefined},endOfLineHandler:function(e){if(e){this[b](e);return}if(this[u]>=this[s][p])if(!this[w]())this[b]();else{var t=this;this[c][E](function(){t[b]()})}},runChildBlock:function(e,n,a){var f=a!=undefined,l=a||new t(this[i]),h=new nt(l,e,this,this[o]);this[c]=h;var y=this,S=function(e){if(e&&!f){y[b](e);return}y[c]=undefined;try{n(e?e[r]:undefined)}catch(t){if(t instanceof J){y[b](t);return}throw t}f||y[w]()!==g&&y[u]<y[s][p]&&y[d]()};h[E](S),setTimeout(function(){try{h[d]()}catch(e){e instanceof J&&S(e),y[v](),Q[m](e),console.log(e)}},0)},getParent:function(){return this.parent}};var rt=undefined,it={number:"Nombre","boolean":"Booleen",string:"Chaine",array:"Tableau"},st=function(e,t,r){if(Array[S](t)){var i=[];for(var s in t){i[h](it[t[s]]);try{if(st(e,t[s],r))return g}catch(o){}}throw new n(e+x+i.join(" ou "),r)}if(typeof e==t||t==T&&angular[S](e))return g;throw new n(e+x+(it[t]||t),r)},ot=function(e,t,n,r){switch(n){case"+":if(typeof e==N||typeof t==N)e=ft(e),t=ft(t);return e+t;case"-":return st(e,C,r),st(t,C,r),e-t;case"*":return st(e,C,r),st(t,C,r),e*t;case"/":return st(e,C,r),st(t,C,r),e/t;case"mod":case"%":return st(e,C,r),st(t,C,r),e%t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t;case"==":return e==t;case"<>":case"!=":return e!=t;case"&&":return st(e,k,r),st(t,k,r),e&&t;case"||":return st(e,k,r),st(t,k,r),e||t;default:return undefined}},ut=function(e,t,n){if(e==undefined||e[p]==0){n();return}var r=e[p],i=-1,s=function(){++i;if(i<r){var o=e[i];t(s,o,i)}else n&&n()};s()},at=function(e,r,s,o){if(e==undefined){o();return}if(typeof e==N||typeof e==C||typeof e==k){o(e);return}if(e.operation||e[L]=="comparaison"||e[L]==k){at(e.left,r,s,function(t){at(e.right,r,s,function(n){var r=ot(t,n,e.operation,e[A]);o(r)})});return}if(e[L]=="var"){r[O](e[M],g,e[A]);var u=r.getValue(e[M]);if(e[_]!=undefined&&e[_][p]>0){var a=[];ut(e[_],function(t,i){if(i=="ADD_AT_END")throw new n("Vous devez préciser l'indice de l'element à accéder.",e[A]);at(i,r,s,function(n){a[h](n),st(u,[T,N],e[A]),u=u[n],u==undefined&&Q[D](P+e[M]+"["+a.join("][")+"] n'est pas initialisée"),t()})},function(){o(u)});return}u==undefined&&Q[D](P+e[M]+" n'est pas initialisée"),o(u);return}if(e[L]==H){r.issetFunction(e[M],g,e[A]);var f=r.getFunction(e[M]);if(typeof f==H){var l=[];ut(e[B],function(e,t){at(t,r,s,function(t){l[h](t),e()})},function(){var e=f.apply(undefined,l);o(e)});return}if(typeof f=="object"){var c=new t(s[i],e[M]);if(f[j][p]!=e[B][p])throw new n("Le nombre de paramétre n'est pas correcte, la fonction "+espression[M]+" prend "+e[B][p]+" paramètre(s)",e[A]);ut(f[j],function(t,n,i){c[F](n[I],n.vartype),at(e[B][i],r,s,function(e){c[q](n[I],e),t()})},function(){s[R](f.body,function(e){o(e)},c)});return}throw new n("La fonction "+e[M]+" n'existe pas",e[A])}if(e[L]==T){var d=[];ut(e.elements,function(e,t){at(t[U],r,s,function(n){t[M]!=undefined?d[t[M]]=n:d[h](n),e()})},function(){o(d)})}},ft=function(e){if(e==undefined)return"NON_INITIALISEE";if(Array[S](e)){var t="[";for(var n in e)t+=" ",isNaN(n)&&(t+=n+" : "),t+=ft(e[n])+",";return t.substring(0,t[p]-1)+" ]"}return e},lt=function(e,t,n,r){if(e[z]=="write")return at(e[B][0],t,n,function(t){var n=ft(t);e[W]&&e[W]==m?Q[m](n):e[W]&&e[W]==D?Q[D](n):Q.write(n),r&&r()}),l;if(e[z]=="define")t[F](e[I],e.vartype);else{if(e[z]=="affectation")return t[O](e[I][M],g,e[A]),at(e[U],t,n,function(i){e[I][_]==undefined&&st(i,t.getType(e[I][M]),e[U][A]||e[A]);var s=[];ut(e[I][_],function(e,r){at(r,t,n,function(t){s[h](t),e()})},function(){t[q](e[I][M],i,s[p]==0?undefined:s),r&&r()})}),l;if(e[z]=="read"){t[O](e[I][M],g,e[A]);var i=t.getType(e[I][M]);return i==T&&Q[D]('Un tableau est une suite de valeurs séparée par des ";", par exemple 1;2;Bonjour;5'),G.read(function(e){var t=it[i]||i;switch(i){case C:if(isNaN(e))return Q[D](X+t+". Entrez une nouvelle valeur"),l;break;case k:if(e!="1"&&e!="0"&&e!=V&&e!="faux")return Q[D](X+t+". Entrez une nouvelle valeur (1, 0, vrai, faux)"),l}return g},function(n){var n=n;i==C?n=parseInt(n,10):i==k?n=n=="1"||n==V:i==T&&(n=n.split(";")),t[q](e[I][M],n),r&&r()}),l}if(e[z]=="return")return at(e[U],t,n,function(e){throw new J(e)}),l}return g},ct={runLine:function(e,t,n,r){var i=g;if(e[L]&&e[L]=="command")i=lt(e,t,n,r);else if(e[L]&&e[L]=="condition")at(e.test,t,n,function(t){st(t,k,e[A]),t&&e.yes&&e.yes[p]>0?n[R](e.yes,r):e.no&&e.no[p]>0?n[R](e.no,r):r&&r()}),i=l;else if(e[L]&&e[L]=="for")t[O](e[I],g,e[A]),at(e.step,t,n,function(i){var s=i===undefined?1:i;at(e.start,t,n,function(i){var o=i-s;at(e.end,t,n,function(i){t[q](e[I],o);var u=function(){o+=s,o<=i?(t[q](e[I],o),n[R](e.block,u)):r&&r()};u()})})}),i=l;else if(e[L]&&e[L]=="forEach"){var s=e[I],o=(s+"_index").toUpperCase();t[O](s,g,e[A]),t[F](o,"NOMBRE"),at(e[T],t,n,function(i){var u=[];for(var a in i)u[h](a);var f=u[p],a=-1,l=function(){a++;if(a<f){var c=u[a],h=i[c];t[q](o,c),t[q](s,h),n[R](e.block,l)}else r&&r()};l()}),i=l}else if(e[L]&&e[L]=="while"){var u=e.test,a=e.block,f=function(){at(u,t,n,function(e){e===g?n[R](a,f):r&&r()})};f(),i=l}else e[L]&&e[L]==H?(at(e,t,n,function(){r&&r()}),i=l):e[L]&&e[L]==$&&t[$](e[M],e[j],e.body);i&&r&&r()}},ht=new t,pt=new nt(ht,K,undefined,ct);pt[E](Y),setTimeout(function(){pt[d]()},0)},K});