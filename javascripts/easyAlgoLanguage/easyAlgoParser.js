// a syntaxique validator for easyAlgo
define(["easyAlgoConfiguration","easyAlgoStringStream","easyAlgoContext","easyAlgoLanguage/easyAlgoParseException","easyAlgoLanguage/mods/base/mod"],function(e,t,n,r,i){var s="stream",o="languageRunnerFactory",u="createOffset",a="parseExpression",f="operationPriority",l="eatSpace",c="pos",h="context",p="errors",d=!1,v="variableNotDefined",m="checkEndOfLine",g="boolean",y="eatWhile",b="parseVarname",w="languageInstruction",E="operation",S="maybeErrors",x="booleanOperation",T="eatEndOfLine",N="eat",C="parseChild",k="spaces",L="function",A="forConfig",O="length",M="backUp",_="toUpperCase",D=!0,P="numberRegex",H="comparaison",B="type",j="priority",F="blocs",I="parseComparaison",q="varTypes",R="createArithmetiqueBoolean",U="parseArithmeticalExpression",z="right",W="FIN_POUR",X="startLinePos",V="functionMalFormated",$="END_OF_BLOCK",J="functionNotDefined",K="parameters",Q="eatWord",G="issetFunction",Y="booleanName",Z="parseVarCall",et="string",tt="createArithmetique",nt="squareNotClosed",rt="FIN_TANT_QUE",it="\n",st="parseBooleanOperator",ot="forMalFormated",ut="defineFunction",at="parseParameterByType",ft="textBetween",lt="parseString",ct="typeNotExist",ht="result",pt="SI_NON_SI",dt="operationRegex",vt="push",mt="command",gt="endInstruction",yt="computeErrors",bt=function(){this[f]={"-":1,"+":1,"&&":2,"||":3,"*":0,"/":0,"%":0},this.definedVars={}};bt.prototype={createAffectation:function(e,t,n){return{type:mt,commandName:"affectation",varname:e,expression:t,offset:n}},createVar:function(e,t,n,r){return{type:"var",name:e[_](),offset:r,indexs:t,attribute:n}},createFunctionCall:function(e,t,n,r){return{type:L,name:e.toLowerCase(),params:n,offset:r}},createOperation:function(e,t,n,r,i){if(n&&n[E]&&!n[j]&&this[f][n[E]]>=this[f][e]&&n[B]==r){var s=n;while(s.left.left&&!s.left[j]&&s.left[B]==s[B]&&this[f][s.left[E]]>=this[f][s[E]])s=s.left;return s.left=this[tt](e,t,s.left,i),n}return{type:r,priority:d,operation:e,left:t,right:n,offset:i}},createArithmetique:function(e,t,n,r){return this.createOperation(e,t,n,"numerique",r)},createArithmetiqueBoolean:function(e,t,n,r){if(t[E]&&!t[j]&&this[f][t[E]]>=this[f][e]&&t[B]==g){var i=t;while(i[z][z]&&!i[z][j]&&i[z][B]==i[B]&&this[f][i[z][E]]>=this[f][i[E]])i=i[z];return i[z]=this[R](e,i[z],n,r),t}return{type:g,priority:d,operation:e,left:t,right:n,offset:r}},createComparison:function(e,t,n,r){return{type:H,left:e,right:t,operation:n,offset:r}},createCondition:function(e,t,n,r){return{type:"condition",test:e,yes:t,no:Array.isArray(n)||n==undefined?n:[n],offset:r}},createWhile:function(e,t,n){return{type:"while",test:e,block:t,offset:n}},createFor:function(e,t,n,r,i,s){return{type:"for",varname:e,start:t,end:n,block:i,offset:s,step:r}},createForEach:function(e,t,n,r){return{type:"forEach",varname:e,array:t,block:n,offset:r}},createArray:function(e,t){return{offset:t,elements:e,type:"array"}},createOffset:function(e,t){return e instanceof wt?{begin:e[X],end:e[s][c]}:{begin:e,end:t}},createFunction:function(e,t,n,r){return{type:ut,parameters:t,body:n,name:e,offset:r}},createDefine:function(e,t,n){return{type:mt,commandName:"define",varname:e,vartype:t,offset:n}}};var wt=function(t,r,s){this[o]=r||new bt,this[w]={SI:this.parseIf,TANT_QUE:this.parseWhile,POUR:this.parseFor,DEFINIR_FONCTION:this.parseFunction},this[F]={"if":[pt,"SI_NON","FIN_SI"],"while":[rt],"for":[W],"function":["FIN_FONCTION"]},this[A]={at:"A",to:"DE","in":"DANS",step:"PAR"},this.writeOutput=e.writeOutput(),this.mods=t||[];var u=this.mods.concat([i]);for(var a in u){var f=u[a]("fr"),l=f.configuration.instructions;for(var a in l)this[w][a]=f.instructions[l[a]]}this.languageWord=["NOMBRE","CHAINE","TABLEAU","BOOLEEN","ECRIRE","DEFINIR","LIRE","SI","TANT_QUE","POUR",pt,"SI_NON","FIN_SI",W,rt,W,"A","DE","DANS","PAR"],this[P]=/[0-9]/,this.varnameRegex=/[a-zA-Z0-9_]/,this[dt]=/[+\-*\/%]/,this[k]=/[\ \t]/,this[Y]=e.getBooleanName(),this[x]={ET:"&&",OU:"||"},this[q]=e.getVarTypes(),this[$]="endOfBlock",this[h]=new n(s),this[p]=[]};return wt.prototype={initParser:function(e){e instanceof t?this[s]=e:this[s]=new t(e+it,4)},checkEndOfLine:function(){this[s][y](this[k]),this[s][N]("/")&&this.parseComment();if(!this[s][T]()&&!this[s].eol()){var e=this[s][c];this[s].skipTo(it),this[p][vt](new r("errorEndOfLine",undefined,e,this[s][c]))}},parse:function(e,t){this.initParser(e);var n=[],i=this[s][c];while(!this[s].eol())try{var o=this[s][c],u=this.parseLine(t);if(typeof u==et&&u.indexOf(this[$])===0)return{endInstruction:u.slice(this[$][O]+1,u[O]),result:n,errors:this[yt](),context:this[h]};this[m](),u!=undefined&&n[vt](u)}catch(a){if(a instanceof r)this[p][vt](a),a.toThrow=D;else if(a[p])for(var f in a[p])this[p][vt](a[p][f]),a[p][f].toThrow=D;this[s].skipTo(it)}if(t&&this[p][O]==0)throw new r("blockNotEnded",[t],i,this[s][c]);return{errors:this[yt](),result:n,context:this[h]}},computeErrors:function(){var e=this[p];if(this[S])for(var t in this[S]){var n=this[S][t],r=d;n.msg==v?this[h].isset(n[K][0],d)||(r=D):n.msg==J&&(this[h][G](n[K][0],d)||(r=D)),r&&e[vt](n)}return e},parseLine:function(e){this[X]=this[s][c],this[s][y](this[k]);var t=this[s].next();if(t==undefined||t==it||t=="\r")return this[s][M](1),undefined;if(t=="/")return this.parseComment();this[s][M](1);var n=this[s][Q](D);if(n===d)throw new r("lineBeginWithInstruction",undefined,this[X],this[s][c]);if(e&&e.indexOf(n)>=0)return"endOfBlock:"+n;if(n in this[w]){this[s][y](this[k]);var i=this[w][n];return typeof i=="object"?this.parseInstruction(i):i.call(this,n)}return this.parseAffectation(n)},parseInstruction:function(e){var t=[0,this[h]];for(var n in e[K]){var i=e[K][n];if(typeof i=="object"){var a=this[s][c],f=this[at](i[B],i.default);i.validator&&i.validator(f,this[o][u](a,this[s][c]))}else var f=this[at](i);if(f==undefined)throw new r(e.badWrittedMessage||"misingParameter",undefined,this);t[vt](f)}t[0]=this[o][u](this);var l=e.runnerFactory;return l.apply(e,t)},parseParameterByType:function(e,t){var n=this[s][c];this[s][N](this[k]);if(this[s][T]())return t!==undefined?(this[s][M](1),t):undefined;if(e==et){var i=this[s].peek();if(this[s][N]('"')||this[s][N]("'")){var o=this[lt](i);return o}if(t===undefined)throw new r("ParameterMustBeString",undefined,n,this[s][c])}else{if(e=="expression")return this[a]();if(e=="var"){var u=this[b]();return this[h].isset(u,d)||this[p][vt](new r(v,[u],this)),this[Z](u,d)}if(e=="varname")return this[b]();if(e=="vartype"){var f=this[s][c],l=this[s][Q](D);if(l in this[q])return this[q][l];throw new r(ct,undefined,f,this[s][c])}}return t},parseAffectation:function(e){this[s][M](e[O]);var t=this[s][c],e=this[Z](this[b](),d);if(!this[h].isset(e.name,d))throw new r(v,[e.name],t,this[s][c]);this[s][l]();if(!this[s][N]("="))throw new r("affectationHaveNotEquals",undefined,this);var n=this[a]();return this[o].createAffectation(e,n,t)},parseChild:function(e,t){var n=new wt(this.mods,this[o],t||this[h]),r=this[s][c],i=n.parse(this[s],e),u=this[s][c];return t&&t.setRange(r,u),i[h].setRange(r,u),i[p]&&i[p][O]>0&&(t?(this[S]=this[S]||[],this[S]=this[S].concat(i[p])):this[p]=this[p].concat(i[p])),i},parseDefineFunctionParameters:function(){var e=this[s][c],t=this[b]();this[s][y](this[k]);if(!this[s][N](":"))throw new r("paramMalFormated",undefined,e,this[s][c]);this[s][y](this[k]);var n=this[s][c],i=this[s][Q](D);if(i in this[q])return this[o].createDefine(t,this[q][i],this[o][u](e,this[s][c]));throw new r(ct,undefined,n,this[s][c])},parseFunction:function(e){var t=this[s][c],i=this[b]();this[h][G](i,d)&&this[p][vt](new r("functionAlreadyDefined",[i],t,this[s][c])),this[s][y](this[k]);if(!this[s][N]("("))throw new r(V,undefined,this);var a=new n(this[h]),f=[];if(!this[s][N](")")){do{this[s][l]();var v=this.parseDefineFunctionParameters();a.defineVar(v.varname,v.vartype),f[vt](v),this[s][l]()}while(this[s][N](";"));if(!this[s][N](")"))throw new r(V,undefined,this)}this[m](),this[h][ut](i,f);var g=this[C](this[F][L],a);return this[o].createFunction(i,f,g[ht],this[o][u](this))},parseIf:function(e){if(this[s][T]())throw new r("ifMalFormated",undefined,this);var t=this[s][c],n=this[a]();this[m]();var i=this[C](this[F]["if"]),f=undefined;if(i[gt]==this[F]["if"][1]){this[m]();var f=this[C]([this[F]["if"][2]]);f=f[ht]}else if(i[gt]==this[F]["if"][0])var f=this.parseIf(e);return this[o].createCondition(n,i[ht],f,this[o][u](t,this[s][c]))},parseWhile:function(e){if(this[s][T]())throw new r("whileMalFormated",undefined,this);var t=this[s][c],n=this[a]();this[m]();var i=this[C](this[F]["while"]);return this[o].createWhile(n,i[ht],this[o][u](t,this[s][c]))},parseFor:function(e){if(this[s][T]())throw new r(ot,undefined,this);var t=this[b]();this[h].isset(t,d)||this[p][vt](new r(v,[t],this));var n=this[s][c];this[s][l]();var i=this[s][Q](D);if(i==this[A]["to"]){this[s][l]();var f=this[a]();this[s][l]();var g=this[s][Q](D);if(g==this[A]["at"]){var y=this[a](),w=this[s][c];this[s][l]();var E=this[s][Q](D),S=undefined;E==this[A]["step"]?S=this[a]():this[s][M](this[s][c]-w),this[m]();var x=this[C](this[F]["for"]);return this[o].createFor(t,f,y,S,x[ht],this[o][u](n,this[s][c]))}}else if(i==this[A]["in"]){this[s][l]();var N=this[a]();this[m](),this[h].defineVar(t+"_INDEX","MIXED");var x=this[C](this[F]["for"]);return this[o].createForEach(t,N,x[ht],this[o][u](n,this[s][c]))}throw new r(ot,undefined,this)},parseExpression:function(){return this.parseComparaisonExpression()},parseComparaisonOperator:function(){var e=this[s][c],t=undefined;this[s][l](),this[s][N]("<")&&(this[s][N](">")?t="!=":this[s][N]("=")?t="<=":t="<"),this[s][N](">")&&(this[s][N]("=")?t=">=":t=">");if(this[s][N]("=")){if(!this[s][N]("="))throw new r("simpleEqualsInExpression",undefined,e,this[s][c]);t="=="}if(this[s][N]("!")){if(!this[s][N]("="))throw new r("exlamationPrevEquals",undefined,e,this[s][c]);t="!="}return t==undefined&&this[s][M](this[s][c]-e),t},parseBooleanOperator:function(){var e=this[x],t=function(t,n){if(t==undefined)return d;var r=d;t=t[_]();for(var i in e)if(i.charAt(n)==t)return D;return r},n=this[s][c];this[s][l]();var r=this[s].next(),i="";while(t(r,i[O]))i+=r,r=this[s].next();return i=i[_](),i in this[x]?i:(this[s][M](this[s][c]-n),undefined)},parseComparaisonExpression:function(){var e=this[I](),t=this[st]();while(t!=undefined){this[s][l]();var n=this[s][c],i=this[I]();if(typeof i!=g&&i[B]!=g&&i[B]!=H&&i[B]!=L||typeof e!=g&&e[B]!=g&&e[B]!=H&&e[B]!=L)throw new r("onlyBooleanAreAllow",undefined,n,this[s][c]);e=this[o][R](this[x][t],e,i,n),t=this[st]()}return e},parseComparaison:function(){var e=this[s][c],t=this[U](),n=this.parseComparaisonOperator();if(n){this[s][l]();var r=this[I]();return this[o].createComparison(t,r,n,this[o][u](e,this[s][c]))}return t},parseArithmeticalExpression:function(){var e=this[s][c],t=this.parsePrimitive(),n=this[s][c];this[s][l]();var i=this[s][N](this[dt]);if(i&&(i!="/"||this[s].peek()!="/"&&this[s].peek()!="*")){this[s][l]();var a=this[U]();if(typeof t==g||typeof a==g)throw new r("booleanNotAllowed",undefined,e,this[s][c]);return this[o][tt](i,t,a,this[o][u](e,this[s][c]))}return this[s][M](this[s][c]-n),t},parsePrimitive:function(){var e=this[s][c];this[s][l]();var t=this[s].next();if(t=="("){if(this[s][N](")"))throw new r("emptyExpression",undefined,this[s][c]);var n=this[s][c],i=this[a]();if(!this[s][N](")"))throw new r("expressionNotEnded",undefined,this[o][u](n,this[s][c]));return i[j]=D,i}if(t=="'"||t=='"')return this[lt](t);if(t=="["){var n=this[s][c];if(this[s][N]("]"))this[s][M](1);else{var f=[];do f[vt](this.parseArrayCell());while(this[s][N](";"))}this[s][l]();if(!this[s][N]("]"))throw new r("arrayDefinitionNotEnded",undefined,this[o][u](n,this[s][c]));return this[o].createArray(f,this[o][u](n,this[s][c]))}this[s][M](1);if(isNaN(t)&&t!="-"){var m=this[b]();if(m in this[Y])return this[Y][m];var g=this[Z](m,D);return g[B]=="var"&&(this[h].isset(g.name,d)||this[p][vt](new r(v,[g.name],g.offset))),g}if(this[P].test(t)||t=="-"){var y=this.parseNumber();return y}throw new r("expressionExpected",undefined,this[o][u](e,this[s][c]))},parseArrayCell:function(){var e=this[s][c];this[s][l]();var t=this[a]();this[s][l]();if(this[s][N](":")){if(typeof t!=et&&typeof t!="number")throw new r("arrayKeyMustBeString",undefined,this[o][u](e,this[s][c]));this[s][l]();var n=this[a]();return{expression:n,name:t,offset:this[o][u](e,this[s][c])}}return{expression:t,offset:this[o][u](e,this[s][c])}},parseNumber:function(){var e=this[s][N]("-")?-1:1,t=this[s][c];this[s][y](this[P]);var n=this[s][ft](t,this[s][c]);if(this[s][N](".")||this[s][N](",")){var t=this[s][c];this[s][y](this[P]);var r=this[s][ft](t,this[s][c]);return e*parseFloat(n+"."+r)}return e*parseInt(n,10)},parseVarCall:function(e,t){var n=undefined,i=d,a=[],f=this[s][c];this[s][y](this[k]);var v=this[s][c];if(this[s][N]("(")){if(!t)throw new r("functionNotAllow",undefined,v,this[s][c]);this[s][l](),a=this.parseFunctionParameters();if(!this[s][N](")"))throw new r(nt,["(",")"],v,this[s][c]);i=D}if(this[s][N]("[")){n=[];do n[vt](this.parseVarIndex());while(this[s][N]("["))}return i?(this[h][G](e,d)||this[p][vt](new r(J,[e],f-e[O],f)),this[o].createFunctionCall(e,n,a,v)):this[o].createVar(e,n,undefined,this[o][u](f-e[O],f))},parseFunctionParameters:function(){this[s][l]();if(this[s].peek()==")")return[];var e=[];do this[s][l](),e[vt](this[a]()),this[s][l]();while(this[s][N](";"));return e},parseVarname:function(){var e=this[s][c];this[s][y](this.varnameRegex);var t=this[s][ft](e,this[s][c])[_]();if(t.trim()[O]==0)throw new r("varnameError",undefined,e,this[s][c]);if(this.languageWord.indexOf(t)>=0)throw this[s][M](this[s][c]-e),new r("varnameErrorLanguage",undefined,e,this[s][c]+t[O]);return t},parseVarIndex:function(){var e=this[s][c];this[s][l]();if(this[s][N]("]"))return"ADD_AT_END";var t=this[a]();if(!this[s][N]("]"))throw new r(nt,["[","]"],e,this[s][c]);return t},parseComment:function(){var e=this[s][c];if(this[s][N]("*")){var t=d;do{t=this[s].skipTo("*");if(!t)throw this[s].skipToEnd(),new r("commentNotEnded",undefined,e-1,this[s][c]);this[s][N]("*"),t=this[s][N]("/")}while(!t)}else this[s][N]("/")&&this[s].skipTo(it)},parseString:function(e){var t=this[s][c],n=this[s].eatTo(e);if(n===d)throw this[s].skipToEnd(),new r("stringNotEnded",[e],t,this[s][c]);var i=this[s][et].slice(this[s][c]-1,this[s][c]);return this[s].next(),i=="\\"&&(subStringRead=this[lt](e),n=n.slice(0,n[O]-1)+e+subStringRead),n}},wt});