// a syntaxique validator for easyAlgo
define(["easyAlgoConfiguration","codemirror/lib/codemirror","easyAlgoContext"],function(e,t,n){var r="stream",i="languageRunnerFactory",s="createOffset",o="parseExpression",u="operationPriority",a="eatSpace",f="pos",l=!1,c="eatWhile",h="checkEndOfLine",p="context",d="boolean",v="errors",m="variableNotDefined",g="parseVarname",y="operation",b=!0,w="maybeErrors",E="booleanOperation",S="StringStream",x="parameters",T="writeOutput",N="toUpperCase",C="textBetween",k="spaces",L="prototype",A="command",O="languageInstruction",M="parseChild",_="eatWord",D="startLinePos",P="function",H="forConfig",B="numberRegex",j="warning",F="startOffset",I="comparaison",q="backUp",R="length",U="blocs",z="parseComparaison",W="priority",X="type",V="varTypes",$="createArithmetiqueBoolean",J="parseArithmeticalExpression",K="string",Q="FIN_POUR",G="endOffset",Y="right",Z="functionMalFormated",et="functionNotDefined",tt="issetFunction",nt="booleanName",rt="\n",it="FIN_TANT_QUE",st="skipTo",ot="END_OF_BLOCK",ut="squareNotClosed",at="parseVarCall",ft="createArithmetique",lt="defineFunction",ct="parseBooleanOperator",ht="forMalFormated",pt="parseString",dt="result",vt="SI_NON_SI",mt="typeNotExist",gt="operationRegex",yt="defineVar",bt="push",wt="endInstruction",Et="computeErrors";t[S][L].eatTo=function(e,t){var n=this[f];return this[st](e)?t===undefined||t===b?this[K].slice(n,this[f]):b:l},t[S][L][C]=function(e,t){return this[K].slice(e,t)},t[S][L][_]=function(e){var t=this[f];if(!this[c](/[\w\$_]/))return l;var n=this[C](t,this[f]);return e?n[N]():n};var St={errorEndOfLine:{message:"La ligne est mal terminée. Du code est présent après votre instruction"},affectationHaveNotEquals:{message:"Une affectation doit avoir la forme suivante. variable = expression"},blockNotEnded:{message:"Le block doit être terminé par {0}"},typeNotExist:{message:"Ce type n'existe pas. Les types possibles sont NOMBRE, CHAINE, BOOLEEN, TABLEAU"},varnameErrorLanguage:{message:"Ce nom de variable ne peut pas être utilisé il fait partie du langage"},lineBeginWithInstruction:{message:"Une ligne doit commencer par une instruction ou une affectation"},writeOutput:{message:'La sortie peut être "erreur" ou "info"'},defineBadWrited:{message:"La définition d'une variable se faire de la facon suivante : DEFINIR nomDeVariable Type"},ifMalFormated:{message:"Un Si s'écrit de la facon suivante : \nSI condition\n	code\nSI_NON_SI condition\n	code\nSI_NON\n	code\nFIN_SI\nSI_NON_SI et SI_NON sont facultatifs"},whileMalFormated:{message:"Un TANT_QUE s'écrit de la facon suivante : \nTANT_QUE condition de continuité\n	code\nFIN_TANT_QUE"},forMalFormated:{message:"Un POUR peux s'écrire de deux façons : \nPOUR variable DE debutInclu A finInclu\n	code\nFIN_POUR\n\nou \nPOUR variable DANS unTableau\n	code\nFIN_POUR"},simpleEqualsInExpression:{message:"Une égalité entre deux expression se fait avec l'opérateur == et non pas ="},exlamationPrevEquals:{message:"L'opérateur de différence est le suivant != et non pas !"},onlyBooleanAreAllow:{message:"Une expression booléenne est attendue"},booleanNotAllowed:{message:"Cette expression ne doit pas retourner un booléen"},emptyExpression:{message:"Une expression vide () n'est pas autorisée"},expressionNotEnded:{message:"Une expression qui commence par une ( doit être terminée par une )"},arrayDefinitionNotEnded:{message:'Un tableau doit être défini de la facon suivante [1; 2; 3; 4; 5] ou ["indice" : value; "indice2" : value2]'},expressionExpected:{message:"Une expression est attendue"},arrayKeyMustBeString:{message:'Une clef de tableau doit être une chaine de caractére ou un nombre comme ceci : ["indice" : value] ou [10 : "bonjour"]'},functionNotAllow:{message:"L'appel à une fonction n'est pas autorisé ici"},squareNotClosed:{message:"Le signe {0} doit être fermé par {1}"},varnameError:{message:"Un nombre de variable ne doit contenir que des caractére alphanumérique et _. Une variable ne doit pas commencer par un nombre"},commentNotEnded:{message:"Votre commentaire n'est pas fermé. Un commentaire peut être de la forme suivante :\n // commentaire sur une line\nou\n/* commentaire \nmultiline\n*/"},stringNotEnded:{message:"Votre chaine de caractére n'est pas fermée. Elle doit être fermée avec le caractére {0}. Par exemple \"Bonjour j\\\"aime les chats\" ou 'Bonjour j\\'aime les chats'"},variableAlreadyDefined:{message:"La variable {0} est déjà définie",severity:j},variableNotDefined:{message:"La variable {0} n'est pas définie",severity:j},functionAlreadyDefined:{message:"La fonction {0} est déjà définie",severity:j},functionNotDefined:{message:"La fonction {0} n'est pas définie",severity:j}},xt=function(e,t,n,i){this.msg=e,this[x]=t,n instanceof Nt?(this[F]=n[D],this[G]=n[r][f]):n.begin?(this[F]=n.begin,this[G]=n.end):(this[F]=n,this[G]=i)};xt[L]={toString:function(){var e=this.msg in St?St[this.msg].message:this.msg;for(var t in this[x]){var n=this[x][t];Array.isArray(n)&&(n=n.join(", ")),e=e.replace("{"+t+"}",this[x][t])}return e},getStart:function(){return this[F]},getEnd:function(){return this[G]},getSeverity:function(){var e=this.msg in St?St[this.msg].severity:undefined;return e||"error"}};var Tt=function(){this[u]={"-":1,"+":1,"&&":2,"||":3,"*":0,"/":0,"%":0},this.definedVars={}};Tt[L]={createAffectation:function(e,t,n){return{type:A,commandName:"affectation",varname:e,expression:t,offset:n}},createVar:function(e,t,n,r){return{type:"var",name:e[N](),offset:r,indexs:t,attribute:n}},createFunctionCall:function(e,t,n,r){return{type:P,name:e.toLowerCase(),params:n,offset:r}},createOperation:function(e,t,n,r,i){if(n&&n[y]&&!n[W]&&this[u][n[y]]>=this[u][e]&&n[X]==r){var s=n;while(s.left.left&&!s.left[W]&&s.left[X]==s[X]&&this[u][s.left[y]]>=this[u][s[y]])s=s.left;return s.left=this[ft](e,t,s.left,i),n}return{type:r,priority:l,operation:e,left:t,right:n,offset:i}},createArithmetique:function(e,t,n,r){return this.createOperation(e,t,n,"numerique",r)},createArithmetiqueBoolean:function(e,t,n,r){if(t[y]&&!t[W]&&this[u][t[y]]>=this[u][e]&&t[X]==d){var i=t;while(i[Y][Y]&&!i[Y][W]&&i[Y][X]==i[X]&&this[u][i[Y][y]]>=this[u][i[y]])i=i[Y];return i[Y]=this[$](e,i[Y],n,r),t}return{type:d,priority:l,operation:e,left:t,right:n,offset:r}},createComparison:function(e,t,n,r){return{type:I,left:e,right:t,operation:n,offset:r}},createWrite:function(e,t){return{type:A,commandName:"write",params:[e],output:t}},createCondition:function(e,t,n,r){return{type:"condition",test:e,yes:t,no:Array.isArray(n)||n==undefined?n:[n],offset:r}},createWhile:function(e,t,n){return{type:"while",test:e,block:t,offset:n}},createFor:function(e,t,n,r,i,s){return{type:"for",varname:e,start:t,end:n,block:i,offset:s,step:r}},createForEach:function(e,t,n,r){return{type:"forEach",varname:e,array:t,block:n,offset:r}},createArray:function(e,t){return{offset:t,elements:e,type:"array"}},createOffset:function(e,t){return e instanceof Nt?{begin:e[D],end:e[r][f]}:{begin:e,end:t}},createDefine:function(e,t,n){return{type:A,commandName:"define",varname:e,vartype:t,offset:n}},createRead:function(e,t){return{type:A,commandName:"read",varname:e,offset:t}},createFunction:function(e,t,n,r){return{type:lt,parameters:t,body:n,name:e,offset:r}},createReturn:function(e,t){return{type:A,commandName:"return",expression:e,offset:t}}};var Nt=function(t,r){this[i]=t||new Tt,this[O]={ECRIRE:this.parseWrite,DEFINIR:this.parseDefine,LIRE:this.parseRead,SI:this.parseIf,TANT_QUE:this.parseWhile,POUR:this.parseFor,DEFINIR_FONCTION:this.parseFunction,RETOURNER:this.parseReturn},this[U]={"if":[vt,"SI_NON","FIN_SI"],"while":[it],"for":[Q],"function":["FIN_FONCTION"]},this[H]={at:"A",to:"DE","in":"DANS",step:"PAR"},this[T]=e[T](),this.languageWord=["NOMBRE","CHAINE","TABLEAU","BOOLEEN","ECRIRE","DEFINIR","LIRE","SI","TANT_QUE","POUR",vt,"SI_NON","FIN_SI",Q,it,Q,"A","DE","DANS","PAR"],this[B]=/[0-9]/,this.varnameRegex=/[a-zA-Z0-9_]/,this[gt]=/[+\-*\/%]/,this[k]=/[\ \t]/,this[nt]=e.getBooleanName(),this[E]={ET:"&&",OU:"||"},this[V]=e.getVarTypes(),this[ot]="endOfBlock",this[p]=new n(r),this[v]=[]};return Nt[L]={initParser:function(e){e instanceof t[S]?this[r]=e:this[r]=new t[S](e+rt,4)},checkEndOfLine:function(){this[r][c](this[k]),this[r].eat("/")&&this.parseComment();if(!this[r].eat(rt)&&!this[r].eol()){var e=this[r][f];throw this[r][st](rt),new xt("errorEndOfLine",undefined,e,this[r][f])}},parse:function(e,t){this.initParser(e);var n=[],i=this[r][f];while(!this[r].eol())try{var s=this[r][f],o=this.parseLine(t);if(typeof o==K&&o.indexOf(this[ot])===0)return{endInstruction:o.slice(this[ot][R]+1,o[R]),result:n,errors:this[Et](),context:this[p]};this[h](),o!=undefined&&n[bt](o)}catch(u){if(u instanceof xt)this[v][bt](u),u.toThrow=b;else if(u[v])for(var a in u[v])this[v][bt](u[v][a]),u[v][a].toThrow=b;console.log(u),this[r][st](rt)}if(t&&this[v][R]==0)throw new xt("blockNotEnded",[t],i,this[r][f]);return{errors:this[Et](),result:n,context:this[p]}},computeErrors:function(){var e=this[v];if(this[w])for(var t in this[w]){var n=this[w][t],r=l;n.msg==m?this[p].isset(n[x][0],l)||(r=b):n.msg==et&&(this[p][tt](n[x][0],l)||(r=b)),r&&e[bt](n)}return e},parseLine:function(e){this[D]=this[r][f],this[r][c](this[k]);var t=this[r].next();if(t==undefined||t==rt)return this[r][q](1),undefined;if(t=="/")return this.parseComment();this[r][q](1);var n=this[r][_](b);if(n===l)throw new xt("lineBeginWithInstruction",undefined,this[D],this[r][f]);return e&&Array.indexOf(e,n)>=0?"endOfBlock:"+n:n in this[O]?(this[r][c](this[k]),this[O][n].call(this,n)):this.parseAffectation(n)},parseWrite:function(){var e=this[o](),t="output";this[r][c](this[k]);var n=this[r].peek();if(this[r].eat('"')||this[r].eat("'")){var u=this[r][f]-1;t=this[pt](n).toLowerCase();if(!(t in this[T]))throw new xt(T,undefined,u,this[r][f]);t=this[T][t]}return this[i].createWrite(e,t,this[i][s](this))},parseDefine:function(){var e=this[r][f],t=this[g]();if(this[r][c](this[k])){var n=this[r][f],o=this[r][_](b);if(o in this[V]){if(this[p].isset(t,l))throw new xt("variableAlreadyDefined",[t],e,n);return this[p][yt](t,this[V][o]),this[i].createDefine(t,this[V][o],this[i][s](this))}throw new xt(mt,undefined,n,this[r][f])}throw new xt("defineBadWrited",undefined,this)},parseRead:function(){var e=this[g]();this[p].isset(e,l)||this[v][bt](new xt(m,[e],this));var t=this[at](e,l);return this[i].createRead(t,this[i][s](this))},parseAffectation:function(e){this[r][q](e[R]);var t=this[r][f],e=this[at](this[g](),l);this[r][a]();if(!this[r].eat("="))throw new xt("affectationHaveNotEquals",undefined,this);var n=this[o]();return this[i].createAffectation(e,n,t)},parseChild:function(e,t){var n=new Nt(this[i],t||this[p]),s=this[r][f],o=n.parse(this[r],e),u=this[r][f];return t&&t.setRange(s,u),o[p].setRange(s,u),o[v]&&o[v][R]>0&&(t?(this[w]=this[w]||[],this[w]=this[w].concat(o[v])):this[v]=this[v].concat(o[v])),o},parseDefineFunctionParameters:function(){var e=this[r][f],t=this[g]();this[r][c](this[k]);if(!this[r].eat(":"))throw new xt("paramMalFormated",undefined,e,this[r][f]);this[r][c](this[k]);var n=this[r][f],o=this[r][_](b);if(o in this[V])return this[i].createDefine(t,this[V][o],this[i][s](e,this[r][f]));throw new xt(mt,undefined,n,this[r][f])},parseFunction:function(e){var t=this[r][f],o=this[g]();this[p][tt](o,l)&&this[v][bt](new xt("functionAlreadyDefined",[o],t,this[r][f])),this[r][c](this[k]);if(!this[r].eat("("))throw new xt(Z,undefined,this);var u=new n(this[p]),d=[];if(!this[r].eat(")")){do{this[r][a]();var m=this.parseDefineFunctionParameters();u[yt](m.varname,m.vartype),d[bt](m),this[r][a]()}while(this[r].eat(";"));if(!this[r].eat(")"))throw new xt(Z,undefined,this)}this[h](),this[p][lt](o,d);var y=this[M](this[U][P],u);return this[i].createFunction(o,d,y[dt],this[i][s](this))},parseReturn:function(){var e=this[o]();return this[i].createReturn(e,this[i][s](this))},parseIf:function(e){if(this[r].eat(rt))throw new xt("ifMalFormated",undefined,this);var t=this[r][f],n=this[o]();this[h]();var u=this[M](this[U]["if"]),a=undefined;if(u[wt]==this[U]["if"][1]){this[h]();var a=this[M]([this[U]["if"][2]]);a=a[dt]}else if(u[wt]==this[U]["if"][0])var a=this.parseIf(e);return this[i].createCondition(n,u[dt],a,this[i][s](t,this[r][f]))},parseWhile:function(e){if(this[r].eat(rt))throw new xt("whileMalFormated",undefined,this);var t=this[r][f],n=this[o]();this[h]();var u=this[M](this[U]["while"]);return this[i].createWhile(n,u[dt],this[i][s](t,this[r][f]))},parseFor:function(e){if(this[r].eat(rt))throw new xt(ht,undefined,this);var t=this[g]();this[p].isset(t,l)||this[v][bt](new xt(m,[t],this));var n=this[r][f];this[r][a]();var u=this[r][_](b);if(u==this[H]["to"]){this[r][a]();var c=this[o]();this[r][a]();var d=this[r][_](b);if(d==this[H]["at"]){var y=this[o](),w=this[r][f];this[r][a]();var E=this[r][_](b),S=undefined;E==this[H]["step"]?S=this[o]():this[r][q](this[r][f]-w),this[h]();var x=this[M](this[U]["for"]);return this[i].createFor(t,c,y,S,x[dt],this[i][s](n,this[r][f]))}}else if(u==this[H]["in"]){this[r][a]();var T=this[o]();this[h](),this[p][yt](t+"_INDEX","MIXED");var x=this[M](this[U]["for"]);return this[i].createForEach(t,T,x[dt],this[i][s](n,this[r][f]))}throw new xt(ht,undefined,this)},parseExpression:function(){return this.parseComparaisonExpression()},parseComparaisonOperator:function(){var e=this[r][f],t=undefined;this[r][a](),this[r].eat("<")&&(this[r].eat(">")?t="!=":this[r].eat("=")?t="<=":t="<"),this[r].eat(">")&&(this[r].eat("=")?t=">=":t=">");if(this[r].eat("=")){if(!this[r].eat("="))throw new xt("simpleEqualsInExpression",undefined,e,this[r][f]);t="=="}if(this[r].eat("!")){if(!this[r].eat("="))throw new xt("exlamationPrevEquals",undefined,e,this[r][f]);t="!="}return t==undefined&&this[r][q](this[r][f]-e),t},parseBooleanOperator:function(){var e=this[E],t=function(t,n){if(t==undefined)return l;var r=l;t=t[N]();for(var i in e)if(i.charAt(n)==t)return b;return r},n=this[r][f];this[r][a]();var i=this[r].next(),s="";while(t(i,s[R]))s+=i,i=this[r].next();return s=s[N](),s in this[E]?s:(this[r][q](this[r][f]-n),undefined)},parseComparaisonExpression:function(){var e=this[z](),t=this[ct]();while(t!=undefined){this[r][a]();var n=this[r][f],s=this[z]();if(typeof s!=d&&s[X]!=d&&s[X]!=I&&s[X]!=P||typeof e!=d&&e[X]!=d&&e[X]!=I&&e[X]!=P)throw new xt("onlyBooleanAreAllow",undefined,n,this[r][f]);e=this[i][$](this[E][t],e,s,n),t=this[ct]()}return e},parseComparaison:function(){var e=this[r][f],t=this[J](),n=this.parseComparaisonOperator();if(n){this[r][a]();var o=this[z]();return this[i].createComparison(t,o,n,this[i][s](e,this[r][f]))}return t},parseArithmeticalExpression:function(){var e=this[r][f],t=this.parsePrimitive(),n=this[r][f];this[r][a]();var o=this[r].eat(this[gt]);if(o&&(o!="/"||this[r].peek()!="/"&&this[r].peek()!="*")){this[r][a]();var u=this[J]();if(typeof t==d||typeof u==d)throw new xt("booleanNotAllowed",undefined,e,this[r][f]);return this[i][ft](o,t,u,this[i][s](e,this[r][f]))}return this[r][q](this[r][f]-n),t},parsePrimitive:function(){var e=this[r][f];this[r][a]();var t=this[r].next();if(t=="("){if(this[r].eat(")"))throw new xt("emptyExpression",undefined,this[r][f]);var n=this[r][f],u=this[o]();if(!this[r].eat(")"))throw new xt("expressionNotEnded",undefined,this[i][s](n,this[r][f]));return u[W]=b,u}if(t=="'"||t=='"')return this[pt](t);if(t=="["){var n=this[r][f];if(this[r].eat("]"))this[r][q](1);else{var c=[];do c[bt](this.parseArrayCell());while(this[r].eat(";"))}this[r][a]();if(!this[r].eat("]"))throw new xt("arrayDefinitionNotEnded",undefined,this[i][s](n,this[r][f]));return this[i].createArray(c,this[i][s](n,this[r][f]))}this[r][q](1);if(isNaN(t)&&t!="-"){var h=this[g]();if(h in this[nt])return this[nt][h];var d=this[at](h,b);return d[X]=="var"&&(this[p].isset(d.name,l)||this[v][bt](new xt(m,[d.name],d.offset))),d}if(this[B].test(t)||t=="-"){var y=this.parseNumber();return y}throw new xt("expressionExpected",undefined,this[i][s](e,this[r][f]))},parseArrayCell:function(){var e=this[r][f];this[r][a]();var t=this[o]();this[r][a]();if(this[r].eat(":")){if(typeof t!=K&&typeof t!="number")throw new xt("arrayKeyMustBeString",undefined,this[i][s](e,this[r][f]));this[r][a]();var n=this[o]();return{expression:n,name:t,offset:this[i][s](e,this[r][f])}}return{expression:t,offset:this[i][s](e,this[r][f])}},parseNumber:function(){var e=this[r].eat("-")?-1:1,t=this[r][f];this[r][c](this[B]);var n=this[r][C](t,this[r][f]);if(this[r].eat(".")||this[r].eat(",")){var t=this[r][f];this[r][c](this[B]);var i=this[r][C](t,this[r][f]);return e*parseFloat(n+"."+i)}return e*parseInt(n,10)},parseVarCall:function(e,t){var n=undefined,o=l,u=[],h=this[r][f];this[r][c](this[k]);var d=this[r][f];if(this[r].eat("(")){if(!t)throw new xt("functionNotAllow",undefined,d,this[r][f]);this[r][a](),u=this.parseFunctionParameters();if(!this[r].eat(")"))throw new xt(ut,["(",")"],d,this[r][f]);o=b}if(this[r].eat("[")){n=[];do n[bt](this.parseVarIndex());while(this[r].eat("["))}return o?(this[p][tt](e,l)||this[v][bt](new xt(et,[e],h-e[R],h)),this[i].createFunctionCall(e,n,u,d)):this[i].createVar(e,n,undefined,this[i][s](h-e[R],h))},parseFunctionParameters:function(){this[r][a]();if(this[r].peek()==")")return[];var e=[];do this[r][a](),e[bt](this[o]()),this[r][a]();while(this[r].eat(";"));return e},parseVarname:function(){var e=this[r][f];this[r][c](this.varnameRegex);var t=this[r][C](e,this[r][f])[N]();if(t.trim()[R]==0)throw new xt("varnameError",undefined,e,this[r][f]);if(Array.indexOf(this.languageWord,t)>=0)throw this[r][q](this[r][f]-e),new xt("varnameErrorLanguage",undefined,e,this[r][f]+t[R]);return t},parseVarIndex:function(){var e=this[r][f];this[r][a]();if(this[r].eat("]"))return"ADD_AT_END";var t=this[o]();if(!this[r].eat("]"))throw new xt(ut,["[","]"],e,this[r][f]);return t},parseComment:function(){var e=this[r][f];if(this[r].eat("*")){var t=l;do{t=this[r][st]("*");if(!t)throw this[r].skipToEnd(),new xt("commentNotEnded",undefined,e-1,this[r][f]);this[r].eat("*"),t=this[r].eat("/")}while(!t)}else this[r].eat("/")&&this[r][st](rt)},parseString:function(e){var t=this[r][f],n=this[r].eatTo(e);if(n===l)throw this[r].skipToEnd(),new xt("stringNotEnded",[e],t,this[r][f]);var i=this[r][K].slice(this[r][f]-1,this[r][f]);return this[r].next(),i=="\\"&&(subStringRead=this[pt](e),n+=e+subStringRead),n}},Nt});