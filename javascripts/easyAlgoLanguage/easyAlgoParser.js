// a syntaxique validator for easyAlgo
define(["easyAlgoConfiguration","easyAlgoStringStream","easyAlgoContext","easyAlgoLanguage/easyAlgoParseException","easyAlgoLanguage/mods/base/mod"],function(e,t,n,r,i){var s="stream",o="languageRunnerFactory",u="createOffset",a="parseExpression",f="operationPriority",l="eatSpace",c="pos",h="context",p="errors",d=!1,v="variableNotDefined",m="checkEndOfLine",g="boolean",y="eatWhile",b="parseVarname",w="languageInstruction",E="operation",S="maybeErrors",x="booleanOperation",T="eatEndOfLine",N="eat",C="toUpperCase",k="length",L="parseChild",A="spaces",O="backUp",M="function",_="forConfig",D="comparaison",P="numberRegex",H=!0,B="type",j="parseComparaison",F="blocs",I="priority",q="varTypes",R="createArithmetiqueBoolean",U="parseArithmeticalExpression",z="eatWord",W="right",X="FIN_POUR",V="endInstruction",$="functionMalFormated",J="END_OF_BLOCK",K="startLinePos",Q="functionNotDefined",G="parameters",Y="issetFunction",Z="booleanName",et="squareNotClosed",tt="parseVarCall",nt="createArithmetique",rt="FIN_TANT_QUE",it="string",st="parseBooleanOperator",ot="forMalFormated",ut="\n",at="parseParameterByType",ft="defineFunction",lt="constants",ct="textBetween",ht="parseString",pt="result",dt="SI_NON_SI",vt="typeNotExist",mt="push",gt="operationRegex",yt="command",bt="computeErrors",wt=function(){this[f]={"-":1,"+":1,"&&":2,"||":3,"*":0,"/":0,"%":0},this.definedVars={}};wt.prototype={createAffectation:function(e,t,n){return{type:yt,commandName:"affectation",varname:e,expression:t,offset:n}},createVar:function(e,t,n,r){return{type:"var",name:e[C](),offset:r,indexs:t,attribute:n}},createFunctionCall:function(e,t,n,r){return{type:M,name:e.toLowerCase(),params:n,offset:r}},createOperation:function(e,t,n,r,i){if(n&&n[E]&&!n[I]&&this[f][n[E]]>=this[f][e]&&n[B]==r){var s=n;while(s.left.left&&!s.left[I]&&s.left[B]==s[B]&&this[f][s.left[E]]>=this[f][s[E]])s=s.left;return s.left=this[nt](e,t,s.left,i),n}return{type:r,priority:d,operation:e,left:t,right:n,offset:i}},createArithmetique:function(e,t,n,r){return this.createOperation(e,t,n,"numerique",r)},createArithmetiqueBoolean:function(e,t,n,r){if(t[E]&&!t[I]&&this[f][t[E]]>=this[f][e]&&t[B]==g){var i=t;while(i[W][W]&&!i[W][I]&&i[W][B]==i[B]&&this[f][i[W][E]]>=this[f][i[E]])i=i[W];return i[W]=this[R](e,i[W],n,r),t}return{type:g,priority:d,operation:e,left:t,right:n,offset:r}},createComparison:function(e,t,n,r){return{type:D,left:e,right:t,operation:n,offset:r}},createCondition:function(e,t,n,r){return{type:"condition",test:e,yes:t,no:Array.isArray(n)||n==undefined?n:[n],offset:r}},createWhile:function(e,t,n){return{type:"while",test:e,block:t,offset:n}},createFor:function(e,t,n,r,i,s){return{type:"for",varname:e,start:t,end:n,block:i,offset:s,step:r}},createForEach:function(e,t,n,r){return{type:"forEach",varname:e,array:t,block:n,offset:r}},createArray:function(e,t){return{offset:t,elements:e,type:"array"}},createOffset:function(e,t){return e instanceof Et?{begin:e[K],end:e[s][c]}:{begin:e,end:t}},createFunction:function(e,t,n,r){return{type:ft,parameters:t,body:n,name:e,offset:r}},createDefine:function(e,t,n){return{type:yt,commandName:"define",varname:e,vartype:t,offset:n}},createConst:function(e,t,n){return{type:"const",name:t,value:e,offset:n}}};var Et=function(t,r,s){this[o]=r||new wt,this[w]={SI:this.parseIf,TANT_QUE:this.parseWhile,POUR:this.parseFor,DEFINIR_FONCTION:this.parseFunction},this[F]={"if":[dt,"SI_NON","FIN_SI"],"while":[rt],"for":[X],"function":["FIN_FONCTION"]},this[_]={at:"A",to:"DE","in":"DANS",step:"PAR"},this.writeOutput=e.writeOutput(),this.mods=t||[];var u=this.mods.concat([i]);for(var a in u){var f=u[a]("fr"),l=f.configuration.instructions;for(var a in l)this[w][a]=f.instructions[l[a]]}this.languageWord=["NOMBRE","CHAINE","TABLEAU","BOOLEEN","ECRIRE","DEFINIR","LIRE","SI","TANT_QUE","POUR",dt,"SI_NON","FIN_SI",X,rt,X,"A","DE","DANS","PAR","VIDE"],this[P]=/[0-9]/,this.varnameRegex=/[a-zA-Z0-9_]/,this[gt]=/[+\-*\/%]/,this[A]=/[\ \t]/,this[Z]=e.getBooleanName(),this[x]={ET:"&&",OU:"||"},this[q]=e.getVarTypes(),this[J]="endOfBlock",this[h]=new n(s),this[p]=[],this[lt]=e.getConstants()};return Et.prototype={initParser:function(e){e instanceof t?this[s]=e:this[s]=new t(e+ut,4)},checkEndOfLine:function(){this[s][y](this[A]),this[s][N]("/")&&this.parseComment();if(!this[s][T]()&&!this[s].eol()){var e=this[s][c];this[s].skipTo(ut),this[p][mt](new r("errorEndOfLine",undefined,e,this[s][c]))}},parse:function(e,t){this.initParser(e);var n=[],i=this[s][c];while(!this[s].eol())try{var o=this[s][c],u=this.parseLine(t);if(typeof u==it&&u.indexOf(this[J])===0)return{endInstruction:u.slice(this[J][k]+1,u[k]),result:n,errors:this[bt](),context:this[h]};this[m](),u!=undefined&&n[mt](u)}catch(a){if(a instanceof r)this[p][mt](a),a.toThrow=H;else if(a[p])for(var f in a[p])this[p][mt](a[p][f]),a[p][f].toThrow=H;this[s].skipTo(ut)}if(t&&this[p][k]==0)throw new r("blockNotEnded",[t],i,this[s][c]);return{errors:this[bt](),result:n,context:this[h]}},computeErrors:function(){var e=this[p];if(this[S])for(var t in this[S]){var n=this[S][t],r=d;n.msg==v?this[h].isset(n[G][0],d)||(r=H):n.msg==Q&&(this[h][Y](n[G][0],d)||(r=H)),r&&e[mt](n)}return e},parseLine:function(e){this[K]=this[s][c],this[s][y](this[A]);var t=this[s].next();if(t==undefined||t==ut||t=="\r")return this[s][O](1),undefined;if(t=="/")return this.parseComment();this[s][O](1);var n=this[s][c],i=this[s][z](H);if(i===d)throw new r("lineBeginWithInstruction",undefined,this[K],this[s][c]);if(e&&e.indexOf(i)>=0)return"endOfBlock:"+i;if(i in this[w]){this[s][y](this[A]);var o=this[w][i];return typeof o=="object"?this.parseInstruction(o):o.call(this,i,n)}return this.parseAffectation(i)},parseInstruction:function(e){var t=[0,this[h]];for(var n in e[G]){var i=e[G][n];if(typeof i=="object"){var a=this[s][c],f=this[at](i[B],i.default);i.validator&&i.validator(f,this[o][u](a,this[s][c]))}else var f=this[at](i);if(f==undefined)throw new r(e.badWrittedMessage||"misingParameter",undefined,this);t[mt](f)}t[0]=this[o][u](this);var l=e.runnerFactory;return l.apply(e,t)},parseParameterByType:function(e,t){var n=this[s][c];this[s][N](this[A]);if(this[s][T]())return t!==undefined?(this[s][O](1),t):undefined;if(e==it){var i=this[s].peek();if(this[s][N]('"')||this[s][N]("'")){var o=this[ht](i);return o}if(t===undefined)throw new r("ParameterMustBeString",undefined,n,this[s][c])}else{if(e=="expression")return this[a]();if(e=="var"){var u=this[b]();return this[h].isset(u,d)||this[p][mt](new r(v,[u],this)),this[tt](u,d)}if(e=="varname")return this[b]();if(e=="vartype"){var f=this[s][c],l=this[s][z](H);if(l in this[q])return this[q][l];throw new r(vt,undefined,f,this[s][c])}}return t},parseAffectation:function(e){this[s][O](e[k]);var t=this[s][c],e=this[tt](this[b](),d);if(!this[h].isset(e.name,d))throw new r(v,[e.name],t,this[s][c]);this[s][l]();if(!this[s][N]("="))throw new r("affectationHaveNotEquals",undefined,this);var n=this[a]();return this[o].createAffectation(e,n,this[o][u](this))},parseChild:function(e,t){var n=new Et(this.mods,this[o],t||this[h]),r=this[s][c],i=n.parse(this[s],e),u=this[s][c];return t&&t.setRange(r,u),i[h].setRange(r,u),i[p]&&i[p][k]>0&&(t?(this[S]=this[S]||[],this[S]=this[S].concat(i[p])):this[p]=this[p].concat(i[p])),i},parseDefineFunctionParameters:function(){var e=this[s][c],t=this[b]();this[s][y](this[A]);if(!this[s][N](":"))throw new r("paramMalFormated",undefined,e,this[s][c]);this[s][y](this[A]);var n=this[s][c],i=this[s][z](H);if(i in this[q])return this[o].createDefine(t,this[q][i],this[o][u](e,this[s][c]));throw new r(vt,undefined,n,this[s][c])},parseFunction:function(e){var t=this[s][c],i=this[b]();this[h][Y](i,d)&&this[p][mt](new r("functionAlreadyDefined",[i],t,this[s][c])),this[s][y](this[A]);if(!this[s][N]("("))throw new r($,undefined,this);var a=new n(this[h]),f=[];if(!this[s][N](")")){do{this[s][l]();var v=this.parseDefineFunctionParameters();a.defineVar(v.varname,v.vartype),f[mt](v),this[s][l]()}while(this[s][N](";"));if(!this[s][N](")"))throw new r($,undefined,this)}this[m](),this[h][ft](i,f);var g=this[L](this[F][M],a);return this[o].createFunction(i,f,g[pt],this[o][u](this))},parseIf:function(e,t){if(this[s][T]())throw new r("ifMalFormated",undefined,this);var n=this[a]();this[m]();var i=this[s][c],f=this[L](this[F]["if"]),l=undefined;if(f[V]==this[F]["if"][1]){this[m]();var l=this[L]([this[F]["if"][2]]);l=l[pt]}else f[V]==this[F]["if"][0]&&(l=this.parseIf(e,this[s][c]-f[V][k]));return this[o].createCondition(n,f[pt],l,this[o][u](t,i))},parseWhile:function(e,t){if(this[s][T]())throw new r("whileMalFormated",undefined,this);var n=this[a]();this[m]();var i=this[s][c],f=this[L](this[F]["while"]);return this[o].createWhile(n,f[pt],this[o][u](t,i))},parseFor:function(e,t){if(this[s][T]())throw new r(ot,undefined,this);var n=this[b]();this[h].isset(n,d)||this[p][mt](new r(v,[n],this)),this[s][l]();var i=this[s][z](H);if(i==this[_]["to"]){this[s][l]();var f=this[a]();this[s][l]();var g=this[s][z](H);if(g==this[_]["at"]){var y=this[a](),w=this[s][c];this[s][l]();var E=this[s][z](H),S=undefined;E==this[_]["step"]?S=this[a]():this[s][O](this[s][c]-w),this[m]();var x=this[s][c],N=this[L](this[F]["for"]);return this[o].createFor(n,f,y,S,N[pt],this[o][u](t,x))}}else if(i==this[_]["in"]){this[s][l]();var C=this[a]();this[m](),this[h].defineVar(n+"_INDEX","MIXED");var x=this[s][c],N=this[L](this[F]["for"]);return this[o].createForEach(n,C,N[pt],this[o][u](t,x))}throw new r(ot,undefined)},parseExpression:function(){return this.parseComparaisonExpression()},parseComparaisonOperator:function(){var e=this[s][c],t=undefined;this[s][l](),this[s][N]("<")&&(this[s][N](">")?t="!=":this[s][N]("=")?t="<=":t="<"),this[s][N](">")&&(this[s][N]("=")?t=">=":t=">");if(this[s][N]("=")){if(!this[s][N]("="))throw new r("simpleEqualsInExpression",undefined,e,this[s][c]);t="=="}if(this[s][N]("!")){if(!this[s][N]("="))throw new r("exlamationPrevEquals",undefined,e,this[s][c]);t="!="}return t==undefined&&this[s][O](this[s][c]-e),t},parseBooleanOperator:function(){var e=this[x],t=function(t,n){if(t==undefined)return d;var r=d;t=t[C]();for(var i in e)if(i.charAt(n)==t)return H;return r},n=this[s][c];this[s][l]();var r=this[s].next(),i="";while(t(r,i[k]))i+=r,r=this[s].next();return i=i[C](),i in this[x]?i:(this[s][O](this[s][c]-n),undefined)},parseComparaisonExpression:function(){var e=this[j](),t=this[st]();while(t!=undefined){this[s][l]();var n=this[s][c],i=this[j]();if(typeof i!=g&&i[B]!=g&&i[B]!=D&&i[B]!=M||typeof e!=g&&e[B]!=g&&e[B]!=D&&e[B]!=M)throw new r("onlyBooleanAreAllow",undefined,n,this[s][c]);e=this[o][R](this[x][t],e,i,n),t=this[st]()}return e},parseComparaison:function(){var e=this[s][c],t=this[U](),n=this.parseComparaisonOperator();if(n){this[s][l]();var r=this[j]();return this[o].createComparison(t,r,n,this[o][u](e,this[s][c]))}return t},parseArithmeticalExpression:function(){var e=this[s][c],t=this.parsePrimitive(),n=this[s][c];this[s][l]();var i=this[s][N](this[gt]);if(i&&(i!="/"||this[s].peek()!="/"&&this[s].peek()!="*")){this[s][l]();var a=this[U]();if(typeof t==g||typeof a==g)throw new r("booleanNotAllowed",undefined,e,this[s][c]);return this[o][nt](i,t,a,this[o][u](e,this[s][c]))}return this[s][O](this[s][c]-n),t},parsePrimitive:function(){var e=this[s][c];this[s][l]();var t=this[s].next();if(t=="("){if(this[s][N](")"))throw new r("emptyExpression",undefined,this[s][c]);var n=this[s][c],i=this[a]();if(!this[s][N](")"))throw new r("expressionNotEnded",undefined,this[o][u](n,this[s][c]));return i[I]=H,i}if(t=="'"||t=='"')return this[ht](t);if(t=="["){var n=this[s][c];if(this[s][N]("]"))this[s][O](1);else{var f=[];do f[mt](this.parseArrayCell());while(this[s][N](";"))}this[s][l]();if(!this[s][N]("]"))throw new r("arrayDefinitionNotEnded",undefined,this[o][u](n,this[s][c]));return this[o].createArray(f,this[o][u](n,this[s][c]))}this[s][O](1);var n=this[s][c],m=this[s][z]();if(m!==d){if(m[C]()in this[lt])return this[o].createConst(this[lt][m],m,this[o][u](n,this[s][c]));this[s][O](m[k])}if(isNaN(t)&&t!="-"){var g=this[b]();if(g in this[Z])return this[Z][g];var y=this[tt](g,H);return y[B]=="var"&&(this[h].isset(y.name,d)||this[p][mt](new r(v,[y.name],y.offset))),y}if(this[P].test(t)||t=="-"){var w=this.parseNumber();return w}throw new r("expressionExpected",undefined,this[o][u](e,this[s][c]))},parseArrayCell:function(){var e=this[s][c];this[s][l]();var t=this[a]();this[s][l]();if(this[s][N](":")){if(typeof t!=it&&typeof t!="number")throw new r("arrayKeyMustBeString",undefined,this[o][u](e,this[s][c]));this[s][l]();var n=this[a]();return{expression:n,name:t,offset:this[o][u](e,this[s][c])}}return{expression:t,offset:this[o][u](e,this[s][c])}},parseNumber:function(){var e=this[s][N]("-")?-1:1,t=this[s][c];this[s][y](this[P]);var n=this[s][ct](t,this[s][c]);if(this[s][N](".")||this[s][N](",")){var t=this[s][c];this[s][y](this[P]);var r=this[s][ct](t,this[s][c]);return e*parseFloat(n+"."+r)}return e*parseInt(n,10)},parseVarCall:function(e,t){var n=undefined,i=d,a=[],f=this[s][c];this[s][y](this[A]);var v=this[s][c];if(this[s][N]("(")){if(!t)throw new r("functionNotAllow",undefined,v,this[s][c]);this[s][l](),a=this.parseFunctionParameters();if(!this[s][N](")"))throw new r(et,["(",")"],v,this[s][c]);i=H}if(this[s][N]("[")){n=[];do n[mt](this.parseVarIndex());while(this[s][N]("["))}return i?(this[h][Y](e,d)||this[p][mt](new r(Q,[e],f-e[k],f)),this[o].createFunctionCall(e,n,a,v)):this[o].createVar(e,n,undefined,this[o][u](f-e[k],f))},parseFunctionParameters:function(){this[s][l]();if(this[s].peek()==")")return[];var e=[];do this[s][l](),e[mt](this[a]()),this[s][l]();while(this[s][N](";"));return e},parseVarname:function(){var e=this[s][c];this[s][y](this.varnameRegex);var t=this[s][ct](e,this[s][c])[C]();if(t.trim()[k]==0)throw new r("varnameError",undefined,e,this[s][c]);if(this.languageWord.indexOf(t)>=0)throw this[s][O](this[s][c]-e),new r("varnameErrorLanguage",undefined,e,this[s][c]+t[k]);return t},parseVarIndex:function(){var e=this[s][c];this[s][l]();if(this[s][N]("]"))return"ADD_AT_END";var t=this[a]();if(!this[s][N]("]"))throw new r(et,["[","]"],e,this[s][c]);return t},parseComment:function(){var e=this[s][c];if(this[s][N]("*")){var t=d;do{t=this[s].skipTo("*");if(!t)throw this[s].skipToEnd(),new r("commentNotEnded",undefined,e-1,this[s][c]);this[s][N]("*"),t=this[s][N]("/")}while(!t)}else this[s][N]("/")&&this[s].skipTo(ut)},parseString:function(e){var t=this[s][c],n=this[s].eatTo(e);if(n===d)throw this[s].skipToEnd(),new r("stringNotEnded",[e],t,this[s][c]);var i=this[s][it].slice(this[s][c]-1,this[s][c]);return this[s].next(),i=="\\"&&(subStringRead=this[ht](e),n=n.slice(0,n[k]-1)+e+subStringRead),n}},Et});